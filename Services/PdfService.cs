using System;using System.Collections.Generic;using System.IO;using EnviadorPagosWPF.Models;using QuestPDF.Fluent;using QuestPDF.Helpers;using QuestPDF.Infrastructure;namespace EnviadorPagosWPF.Services;public class PdfService{public byte[] BuildPaymentReceiptPdf(PaymentRow p,string companyName){return Document.Create(c=>{c.Page(pg=>{pg.Margin(35);pg.Size(PageSizes.A4);pg.Header().Text("PAGO EFECTUADO - "+companyName).SemiBold().FontSize(16);pg.Content().PaddingVertical(10).Column(col=>{col.Item().Text("Documento: "+p.DocNum+"  (DocEntry "+p.DocEntry+")");col.Item().Text("Fecha: "+p.DocDate.ToString("dd/MM/yyyy"));col.Item().Text("Proveedor: "+p.CardCode+" - "+p.CardName);col.Item().Text("Moneda: "+p.DocCurrency);col.Item().LineHorizontal(0.5f);col.Item().Text("Totales del pago").SemiBold();col.Item().Table(t=>{t.ColumnsDefinition(c=>{c.RelativeColumn();c.ConstantColumn(120);});void R(string n,decimal v){t.Cell().Text(n);t.Cell().AlignRight().Text(string.Format("{0:###,##0.00} {1}",v,p.DocCurrency));}R("Efectivo",p.CashSum);R("Cheque",p.CheckSum);R("Transferencia",p.TransferSum);R("Total documento",p.DocCurrency=="MXN"?p.DocTotal:p.DocTotalFC);});col.Item().PaddingTop(6).Text("Facturas pagadas").SemiBold();col.Item().Table(t=>{t.ColumnsDefinition(c=>{c.ConstantColumn(60);c.ConstantColumn(80);c.RelativeColumn();c.ConstantColumn(90);c.ConstantColumn(70);});t.Header(h=>{h.Cell().Text("DocNum").SemiBold();h.Cell().Text("Fecha").SemiBold();h.Cell().Text("Factura Proveedor").SemiBold();h.Cell().Text("Aplicado").SemiBold();h.Cell().Text("Moneda").SemiBold();});foreach(var inv in p.Invoices){t.Cell().Text(inv.DocNum.ToString());t.Cell().Text(inv.DocDate.ToString("dd/MM/yyyy"));t.Cell().Text(inv.NumAtCard);t.Cell().AlignRight().Text(string.Format("{0:###,##0.00}",inv.SumApplied));t.Cell().AlignRight().Text(inv.DocCurrency);}});if(!string.IsNullOrWhiteSpace(p.AttachmentPath)){col.Item().PaddingTop(8).Text("Adjuntos del pago (SAP)").SemiBold();col.Item().Text(p.AttachmentPath);}});pg.Footer().AlignRight().Text(x=>{x.Span("PÃ¡gina ");x.CurrentPageNumber();x.Span(" de ");x.TotalPages();});});}).GeneratePdf();}public byte[] ConvertImageToPdf(string path){return Document.Create(c=>{c.Page(p=>{p.Margin(20);p.Size(PageSizes.A4);p.Content().Image(path).FitArea();});}).GeneratePdf();}public List<(string fileName,byte[] data)> PrepareAttachments(PaymentRow p){var l=new List<(string,byte[])>();l.Add(("Recibo_pago_"+p.DocNum+".pdf",BuildPaymentReceiptPdf(p,"SAP Business One HANA")));if(!string.IsNullOrWhiteSpace(p.AttachmentPath)&&File.Exists(p.AttachmentPath)){var ext=Path.GetExtension(p.AttachmentPath).ToLowerInvariant();var name=Path.GetFileNameWithoutExtension(p.AttachmentPath);if(ext==".pdf")l.Add((Path.GetFileName(p.AttachmentPath),File.ReadAllBytes(p.AttachmentPath)));else if(ext==".png"||ext==".jpg"||ext==".jpeg"||ext==".gif"||ext==".bmp")l.Add((name+".pdf",ConvertImageToPdf(p.AttachmentPath)));else l.Add((Path.GetFileName(p.AttachmentPath),File.ReadAllBytes(p.AttachmentPath)));}return l;} }
